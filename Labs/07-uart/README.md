# Lab 7: ADC, serial communication, UART

#### Contents

1. [Lab prerequisites](#Lab-prerequisites)
2. [Used hardware components](#Used-hardware-components)
3. [Synchronize Git and create a new project](#Synchronize-Git-and-create-a-new-project)
4. [Analog-to-Digital Conversion](#Analog-to-Digital-Conversion)
5. [UART communication](#UART-communication)
6. [Clean project and synchronize git](#Clean-project-and-synchronize-git)
7. [Ideas for other tasks](#Ideas-for-other-tasks)


## Lab prerequisites

1. Use schematic of the [LCD keypad shield](../../Docs/arduino_shield.pdf) and find out the connection of Select, Left, Up, Down, and Right push buttons. Calculate the voltage values for all voltage dividers. Calculate the ADC values ​​for input voltages according to the equation ![equation](https://latex.codecogs.com/gif.latex?ADC%20%3D%20%5Cfrac%7BV_%7BA0%7D%7D%7BV_%7Bref%7D%7D%5Ccdot%20%282%5En-1%29) where reference voltage ![equation](https://latex.codecogs.com/gif.latex?V_%7Bref%7D%20%3D%205V) and number of bits for AD conversion is ![equation](https://latex.codecogs.com/gif.latex?n%20%3D%2010).

    | **Push button** | **Voltage divider** | **ADC value (calculated)** | **ADC value (measured)** |
    | :-: | :-: | :-: | :-: |
    | RIGHT | ![equation](https://latex.codecogs.com/gif.latex?V_%7BA0%7D%20%3D%20%5Cfrac%7B0%7D%7BR2%7D%5Ccdot%205V%20%3D%200) | ![equation](https://latex.codecogs.com/gif.latex?ADC%20%3D%20%5Cfrac%7BV_%7BA0%7D%7D%7BV_%7Bref%7D%7D%5Ccdot%20%282%5En-1%29%20%3D%20%5Cfrac%7B0%7D%7B5V%7D%5Ccdot%201023%20%3D%200) |  |
    | UP | ![equation](https://latex.codecogs.com/gif.latex?V_%7BA0%7D%20%3D%20%5Cfrac%7BR3%7D%7BR3&plus;R2%7D%5Ccdot%205V%20%3D%200.495V) | ![equation](https://latex.codecogs.com/gif.latex?ADC%20%3D%20%5Cfrac%7BV_%7BA0%7D%7D%7BV_%7Bref%7D%7D%5Ccdot%20%282%5En-1%29%20%3D%20%5Cfrac%7B0.495%7D%7B5V%7D%5Ccdot%201023%20%3D%20101) |  |
    | DOWN | <br>&nbsp; |  |  |
    | LEFT | <br>&nbsp; |  |  |
    | SELECT | <br>&nbsp; |  |  |

    > Equations were generated by [Online LaTeX Equation Editor](https://www.codecogs.com/latex/eqneditor.php).
    >


## Used hardware components

1. [ATmega328P](https://www.microchip.com/wwwproducts/en/ATmega328P) 8-bit AVR microcontroller.
2. [Arduino Uno](../../Docs/arduino_shield.pdf) board.
3. [LCD keypad shield](../../Docs/arduino_shield.pdf) with LCD and five push buttons.
4. 24MHz 8-channel [logic analyzer](https://www.saleae.com/).

&nbsp;
![lcd_shield](../../Images/lcd_shield.jpg "LCD keypad shield")


## Synchronize Git and create a new project

1. In VS Code open your Digital-electronics-2 working directory and synchronize the contents with single git command `git pull` or sequence of two commands `git fetch` followed by `git merge`.

2. Create a new folder `Labs/07-uart` and copy files from the last project.


## Analog-to-Digital Conversion

1. According to the [ATmega328P datasheet](https://www.microchip.com/wwwproducts/en/ATmega328p) which I/O registers and bits configure operations of internal ADC module (see Analog-to-Digital Converter section)?

    | **Operation** | **Code** | **Description** |
    | :-: | :-- | :-- |
    | Voltage reference | `ADMUX \|= _BV(REFS0);`<br>`ADMUX \|= _BV(REFS1) \| _BV(REFS0);` | AVcc voltage reference (5V)<br>Internal 1.1V reference&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |
    | Analog input |  | Channel ADC0 |
    | ADC clock divider |  | Division factor = 64, fadc =<br>Division factor = 128, fadc =   |
    | ADC enable |  |  |
    | ADC interrupt enable |  |  |
    | Start conversion |  |  |
    | ADC result |  |  |


## UART communication

1. What ASCII code/character is transmitting in UART (Universal asynchronous receiver-transmitter) 8N1 mode? According to bit period (one bit duration), estimate the symbol rate.

    &nbsp;
    ![uart_example](../../Images/uart_capture_E.png "UART signal")

    | **UART mode** | **Frame structure** | **ASCII code** | **Baud rate** |
    | :-: | :-: | :-: | :-: |
    | 8N1 | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |  |

2. What is the meaning of ASCII control characters `\r`, `\n`, and `\b`? What codes are defined for these characters in [ASCII table](http://www.asciitable.com/)?

    | **Character** | **ASCII code** | **Description** |
    | :-: | :-: | :-- |
    | `\r` |  | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |
    | `\n` |  |  |
    | `\b` |  |  |

3. *In the lab, we are using [UART library](http://www.peterfleury.epizy.com/avr-software.html) developed by Peter Fleury.* Use online manual of UART library and add the input parameters (output values) and description of the functions to the following table.

    | **Function** | **Parameter(s)** | **Description** |
    | :-: | :-: | :-- |
    | `uart_init` | `UART_BAUD_SELECT(9600, F_CPU)` | Initialize UART to 8N1 and set baudrate to 9600 Bd |
    | `uart_getc` |  |  |
    | `uart_putc` |  |  |
    | `uart_puts` |  |  |

4. Use template from [teacher's GitHub](https://github.com/tomas-fryza/Digital-electronics-2/blob/master/Labs/07-uart/main.c) and configure ADC (AVcc with external capacitor voltage reference, channel ADC0, prescaler 128, enable interrupt), Timer1 (start ADC conversion every second), and UART (mode 8N1, baud rate 9600) modules.

    Read voltage level of push buttons and transmit it to UART. Use PuTTY SSH Client to receive values from Arduino board. Setup the application as follows:

    | **Category** | **Parameter** | **Value/Description** |
    | :-: | --: | :-- |
    | Session | Connection type | Serial
    | Serial | Serial line to connect to | `/dev/ttyUSB0`<br>(You can use `dmesg` Linux command to verify your port) |
    |  | Speed (baud) | 9600 |
    |  | Data bits | 8 |
    |  | Stop bits | 1 |
    |  | Parity | None |
    |  | Flow control | XON/XOFF |
    | Session | Saved Sessions | usb0 |
    |  | button Save | (Save all your settings) |
    |  | button Load | (Load your saved settings) |
    |  | button Open | Open UART connection |

    > WARNING: Before Arduino board re-programming process, PuTTY SSH Client must be closed!
    >

5. Compare measured ADC values with calculated ones. Program a routine to identify which push button was pressed according to the ADC value.


## Clean project and synchronize git

Remove all binaries and object files from the working directory and push all local changes to your remote repository.


## Ideas for other tasks

1. Use [ANSI escape sequences](https://en.wikipedia.org/wiki/ANSI_escape_code) and modify color and format of transmitted strings according to the following code. Try other formatting styles.

    ```C
    /* Color/formatting sequence always starts by "\033[" and ends by "m" strings.
    * One or more formatting codes "#", separated by ";" can be used within
    * one line, such as:
    *    \033[#m      or
    *    \033[#;#m    or
    *    \033[#;#;#m  etc. */
    uart_puts("\033[4;32m");        // 4: underline style; 32: green foreground
    uart_puts("This is all Green and Underlined.");
    uart_puts("\033[0m");           // 0: reset all attributes
    uart_puts("This is Normal text again.");
    ```

2. Program an interactive console that communicates between ATmega328P and the computer (PuTTY application) via UART. Let the main screen of the console is as follows:

    ```bash
    --- Interactive UART console ---
    1: read current Timer/counter1 value
    2: reset Timer/counter1
    > 
    ```

    After pressing the '1' key on computer keyboard, ATmega328P receives ASCII code of the key and sends the current Timer1 value back to PuTTY. After pressing the '2' key, ATmega328P resets Timer1 value, etc. Use ANSI escape sequences to highlight information within PuTTY console.

    ```C
    uint8_t c;
    ...
    
    c = uart_getc();
    if (c != '\0') {        // Data available from UART
        if (c == '1') {     // Key '1' received
            ...
        }
    }
    ```

3. Program a software UART transmitter that will be able to generate UART data on any output pin of the ATmega328P microcontroller. Let the baudrate be equal to 9600 Bd. Consider also the possibility of calculating the parity bit.

4. Verify the UART communication with logic analyzer.
